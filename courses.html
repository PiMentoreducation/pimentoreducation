<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Buy Courses | PiMentor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/courses.css">
</head>
<body>

<header class="top-bar">
  <h1>Enroll to new Courses</h1>
  <button onclick="window.location.href='dashboard.html'">Dashboard</button>
</header>

<div class="course-container" id="courseContainer">
    <p id="statusMessage">Loading courses...</p>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const token = localStorage.getItem("token");
  const user = JSON.parse(localStorage.getItem("user"));

  // Auth Guard
  if (!token || !user) {
    window.location.href = "login.html";
    return;
  }

  const container = document.getElementById("courseContainer");

  try {
    /* STEP 1: FETCH DATA
       We fetch both the catalog and the user's specific purchases.
    */
    const [courseRes, purchaseRes] = await Promise.all([
      fetch("https://pimentor-project.onrender.com/api/purchase/all-courses", {
        headers: { "Authorization": "Bearer " + token }
      }),
      fetch("https://pimentor-project.onrender.com/api/purchase/my-courses", {
        headers: { "Authorization": "Bearer " + token }
      })
    ]);

    if (!courseRes.ok || !purchaseRes.ok) throw new Error("Server responded with an error");

    const allCourses = await courseRes.json();
    const purchasedRecords = await purchaseRes.json();
    const now = new Date();

    container.innerHTML = ""; // Clear loading message

    if (allCourses.length === 0) {
      container.innerHTML = "<p>No courses are currently available.</p>";
      return;
    }

    allCourses.forEach(course => {
      /* LOGIC UPGRADE: 
         Instead of just checking if it exists, we find the LATEST 
         purchase for this ID and check if it is still valid.
      */
      const userPurchases = purchasedRecords.filter(p => p.courseId === course.courseId);
      
      // Sort newest first
      userPurchases.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      const latest = userPurchases;

      let isStillActive = false;
      if (latest && latest.expiryDate) {
          const expiry = new Date(latest.expiryDate);
          if (expiry > now) {
              isStillActive = true; // Student still has time left
          }
      }

      const div = document.createElement("div");
      div.className = "course-card";
      
      // Determine Button State
      let buttonText = "Buy Now";
      let isDisabled = false;

      if (isStillActive) {
          buttonText = "Purchased";
          isDisabled = true;
      } else if (latest) {
          // It exists but is expired
          buttonText = "Renew Now";
          isDisabled = false;
      }

      div.innerHTML = `
        <h3>${course.title}</h3>
        <p><strong>${course.className || 'General'}</strong></p>
        <p class="description">${course.description || ''}</p>
        <p class="price">â‚¹${course.price}</p>
        <button ${isDisabled ? "disabled" : ""} id="btn-${course.courseId}">
          ${buttonText}
        </button>
      `;

      if (!isDisabled) {
        div.querySelector("button").onclick = () => buyCourse(course);
      }
      container.appendChild(div);
    });

  } catch (err) {
    console.error("Failed to load data:", err);
    document.getElementById("statusMessage").innerText = "Error: Could not connect to the PiMentor database.";
  }
});

/* STEP 3: PAYMENT & DATABASE SYNC
   Initiates Razorpay and saves the record to the Purchase collection.
*/
async function buyCourse(course) {
  const token = localStorage.getItem("token");

  try {
    const res = await fetch("https://pimentor-project.onrender.com/api/payment/create-order", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify({
        courseId: course.courseId,
        title: course.title,
        price: course.price,
        className: course.className,
        liveValidityDate: course.liveValidityDate,
        recordedDurationDays: course.recordedDurationDays
      })
    });

    const data = await res.json();
    const order = data.order || data; 

    const options = {
      key: "rzp_test_SIWx62DBo83S8C", 
      amount: order.amount,
      currency: "INR",
      name: "PiMentor",
      description: course.title,
      order_id: order.id,
      handler: async function (response) {
        
        const saveRes = await fetch("https://pimentor-project.onrender.com/api/payment/verify", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          body: JSON.stringify({
            razorpay_order_id: response.razorpay_order_id,
            razorpay_payment_id: response.razorpay_payment_id,
            razorpay_signature: response.razorpay_signature,
            course: {
              courseId: course.courseId,
              title: course.title,
              className: course.className,
              price: course.price,
              liveValidityDate: course.liveValidityDate,
              recordedDurationDays: course.recordedDurationDays
            }
          })
        });

        if (saveRes.ok) {
          alert("Payment Successful! Access granted/renewed.");
          window.location.href = "dashboard.html";
        } else {
          alert("Verification failed. Please contact support.");
        }
      },
      theme: { color: "#3399cc" }
    };

    const rzp = new Razorpay(options);
    rzp.open();

  } catch (error) {
    console.error("Payment Error:", error);
    alert("Purchase process failed. Try again.");
  }
}
</script>

</body>
</html>