<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Buy Courses | PiMentor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/courses.css">
</head>
<body>

<header class="top-bar">
  <h1>Enroll to new Courses</h1>
  <button onclick="window.location.href='dashboard.html'">Dashboard</button>
</header>

<div class="course-container" id="courseContainer">
    <p id="statusMessage">Loading courses...</p>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const token = localStorage.getItem("token");
  const userData = JSON.parse(localStorage.getItem("user") || "{}");
  const currentUserId = userData.id || userData._id;

  // 1. Auth Guard
  if (!token || !currentUserId) {
    window.location.href = "login.html";
    return;
  }

  const container = document.getElementById("courseContainer");

  try {
    /* STEP 1: FETCH DATA */
    const [courseRes, purchaseRes] = await Promise.all([
      fetch("https://pimentor-project.onrender.com/api/purchase/all-courses", {
        headers: { "Authorization": "Bearer " + token }
      }),
      fetch("https://pimentor-project.onrender.com/api/purchase/my-courses", {
        headers: { "Authorization": "Bearer " + token }
      })
    ]);

    if (!courseRes.ok || !purchaseRes.ok) throw new Error("Server Error");

    const allCourses = await courseRes.json();
    const purchasedRecords = await purchaseRes.json();
    
    const nowMs = Date.now();
    container.innerHTML = ""; 

    if (allCourses.length === 0) {
      container.innerHTML = "<p>No courses are currently available.</p>";
      return;
    }

    /* STEP 2: RENDER COURSES WITH EXPIRY LOGIC */
    allCourses.forEach(course => {
      // Filter records for this specific user and course
      const myPurchases = purchasedRecords.filter(p => 
          String(p.courseId).trim() === String(course.courseId).trim() &&
          String(p.userId) === String(currentUserId)
      );
      
      let isStillActive = false;
      let hasPreviousPurchase = myPurchases.length > 0;

      if (hasPreviousPurchase) {
          myPurchases.forEach(p => {
              if (p.expiryDate) {
                  const expMs = new Date(p.expiryDate).getTime();
                  if (!isNaN(expMs) && expMs > nowMs) {
                      isStillActive = true; 
                  }
              }
          });
      }

      const div = document.createElement("div");
      div.className = "course-card";
      
      let buttonText = "Buy Now";
      let isDisabled = false;
      let btnBg = "#1a73e8";

      if (isStillActive) {
          buttonText = "Purchased";
          isDisabled = true;
          btnBg = "#6c757d"; 
      } else if (hasPreviousPurchase) {
          buttonText = "Renew Now";
          isDisabled = false;
          btnBg = "#f39c12"; 
      }

      div.innerHTML = `
        <h3>${course.title}</h3>
        <p><strong>${course.className || 'General'}</strong></p>
        <p class="description">${course.description || ''}</p>
        <p class="price">â‚¹${course.price}</p>
        <button ${isDisabled ? "disabled" : ""} id="btn-${course.courseId}" 
                style="background: ${btnBg}; color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; font-weight: bold; cursor: ${isDisabled ? 'not-allowed' : 'pointer'};">
          ${buttonText}
        </button>
      `;

      if (!isDisabled) {
        div.querySelector("button").onclick = () => buyCourse(course);
      }
      container.appendChild(div);
    });

    /* STEP 3: DIRECT-TO-PAY AUTO TRIGGER (DASHBOARD REDIRECT) */
    const urlParams = new URLSearchParams(window.location.search);
    const renewId = urlParams.get('renew');

    if (renewId) {
        // Find the course in the catalog we just loaded
        const targetCourse = allCourses.find(c => String(c.courseId).trim() === String(renewId).trim());
        
        if (targetCourse) {
            console.log("Auto-initiating payment for course:", targetCourse.title);
            // Small delay to let the browser process the UI, then pop Razorpay
            setTimeout(() => {
                buyCourse(targetCourse);
            }, 700);
        }
    }

  } catch (err) {
    console.error("Critical Render Error:", err);
    document.getElementById("statusMessage").innerText = "Database Error. Please refresh.";
  }
});

/* STEP 4: RAZORPAY PAYMENT LOGIC (RETAINED) */
async function buyCourse(course) {
  const token = localStorage.getItem("token");

  try {
    const res = await fetch("https://pimentor-project.onrender.com/api/payment/create-order", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify({
        courseId: course.courseId,
        title: course.title,
        price: course.price,
        className: course.className,
        liveValidityDate: course.liveValidityDate,
        recordedDurationDays: course.recordedDurationDays
      })
    });

    const data = await res.json();
    const order = data.order || data; 

    const options = {
      key: "rzp_test_SIWx62DBo83S8C", 
      amount: order.amount,
      currency: "INR",
      name: "PiMentor",
      description: course.title,
      order_id: order.id,
      handler: async function (response) {
        const saveRes = await fetch("https://pimentor-project.onrender.com/api/payment/verify", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          body: JSON.stringify({
            razorpay_order_id: response.razorpay_order_id,
            razorpay_payment_id: response.razorpay_payment_id,
            razorpay_signature: response.razorpay_signature,
            course: {
              courseId: course.courseId,
              title: course.title,
              className: course.className,
              price: course.price,
              liveValidityDate: course.liveValidityDate,
              recordedDurationDays: course.recordedDurationDays
            }
          })
        });

        if (saveRes.ok) {
          alert("Payment Successful! Access updated.");
          window.location.href = "dashboard.html";
        } else {
          alert("Payment verified but database update failed. Please contact support.");
        }
      },
      theme: { color: "#3399cc" }
    };

    const rzp = new Razorpay(options);
    rzp.open();

  } catch (error) {
    console.error("Payment Error:", error);
    alert("The purchase process failed. Please try again.");
  }
}
</script>

</body>
</html>