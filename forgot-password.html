<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Reset Password | PiMentor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="auth.css">
    <style>
        .input-group { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 15px; 
            align-items: center;
        }
        
        .input-group input {
            flex: 1.5; /* Gives slightly more space to input */
            margin-bottom: 0 !important;
        }

        .btn-small { 
            flex: 1; /* Gives enough width for "Send OTP" text */
            height: 45px; 
            cursor: pointer; 
            background: #4CAF50; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            font-size: 0.85rem;
            white-space: nowrap;
        }

        button:disabled { background-color: #ccc !important; cursor: not-allowed; }

        #otp-section, #reset-section { 
            display: none; 
            border-top: 1px dashed #ddd; 
            padding-top: 15px; 
            margin-top: 10px; 
        }

        /* Consistent input styling from register.html */
        .auth-card form input {
            width: 100%;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
<div class="auth-container">
    <div class="auth-card">
        <h1>Reset Password</h1>
        <p>Enter your registered email to receive an OTP</p>

        <form id="forgotForm">
            <div class="input-group">
                <input type="email" id="email" placeholder="Registered Email" required>
                <button type="button" id="sendBtn" class="btn-small" onclick="handleSendOTP()">Send OTP</button>
            </div>

            <div id="otp-section">
                <div class="input-group">
                    <input type="text" id="otp-input" placeholder="6-Digit OTP" maxlength="6">
                    <button type="button" class="btn-small" onclick="handleVerifyOTP()" style="background:#2196F3;">Verify Code</button>
                </div>
            </div>

            <div id="reset-section">
                <input type="password" id="new-password" placeholder="Enter New Password" required minlength="6">
                <button type="submit" id="updateBtn" class="btn-small" style="width:100%; background:#f44336;">Update Password</button>
            </div>
        </form>
        <p class="switch"><a href="login.html">Back to Login</a></p>
    </div>
</div>



<script>
const BASE_URL = "https://pimentor-project.onrender.com";
let timerOn = false;

// 0. Timer Logic
function startTimer(remaining) {
    const sendBtn = document.getElementById('sendBtn');
    timerOn = true;
    
    const interval = setInterval(() => {
        remaining -= 1;
        sendBtn.innerText = `${remaining}s`;
        sendBtn.disabled = true;
        
        if (remaining <= 0) {
            clearInterval(interval);
            sendBtn.innerText = "Resend";
            sendBtn.disabled = false;
            timerOn = false;
        }
    }, 1000);
}

// 1. Send OTP logic with Timer and 'forgot' flag
async function handleSendOTP() {
    if (timerOn) return; // Block execution if timer is active

    const email = document.getElementById('email').value;
    const btn = document.getElementById('sendBtn');
    
    if (!email) return alert("Please enter your registered email.");

    try {
        btn.disabled = true;
        btn.innerText = "...";
        
        const res = await fetch(`${BASE_URL}/api/auth/send-otp`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                email: email, 
                type: 'forgot' 
            })
        });

        const data = await res.json();

        if (res.ok) {
            alert("OTP sent to your email!");
            document.getElementById('otp-section').style.display = 'block';
            startTimer(60); // Start the 1-minute countdown
        } else {
            alert(data.message || "Error sending OTP.");
            btn.disabled = false;
            btn.innerText = "Send OTP";
        }
    } catch (err) { 
        alert("Server error. Check if backend is running."); 
        btn.disabled = false; 
        btn.innerText = "Send OTP";
    }
}

// 2. Verify OTP logic
async function handleVerifyOTP() {
    const email = document.getElementById('email').value;
    const otp = document.getElementById('otp-input').value;
    
    if (!otp) return alert("Enter the 6-digit code.");

    try {
        const res = await fetch(`${BASE_URL}/api/auth/verify-otp`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, otp })
        });
        const data = await res.json();
        
        if (data.success) {
            alert("Verified! Now set your new password.");
            document.getElementById('otp-section').style.display = 'none';
            document.getElementById('sendBtn').style.display = 'none';
            document.getElementById('email').readOnly = true;
            document.getElementById('reset-section').style.display = 'block';
        } else { 
            alert(data.message); 
        }
    } catch (err) { 
        alert("Verification failed."); 
    }
}

// 3. Final Reset Password submission
document.getElementById("forgotForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    
    const email = document.getElementById('email').value;
    const newPassword = document.getElementById('new-password').value;
    const updateBtn = document.getElementById('updateBtn');

    updateBtn.disabled = true;
    updateBtn.innerText = "Updating...";

    try {
        const res = await fetch(`${BASE_URL}/api/auth/reset-password`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, newPassword })
        });
        
        const data = await res.json();

        if (res.ok) {
            alert("Password updated successfully! Please login.");
            window.location.href = "login.html";
        } else {
            alert(data.message || "Reset failed.");
            updateBtn.disabled = false;
            updateBtn.innerText = "Update Password";
        }
    } catch (err) { 
        alert("Reset failed. Connection error."); 
        updateBtn.disabled = false;
        updateBtn.innerText = "Update Password";
    }
});
</script>
</body>
</html>